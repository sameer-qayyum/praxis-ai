# Public Form Submission API

This API allows publicly shared V0-generated apps to submit or update form data in users' Google Sheets without exposing OAuth credentials or requiring API keys.

## URL Structure

```
POST /api/public/forms/{appId}/{pathSecret}/submit
```

- `appId`: UUID of the app
- `pathSecret`: Auto-generated secure path segment (32 characters) that acts as authentication

## Authentication

Authentication is URL-based. Each app has a unique `appId` and `pathSecret` combination. The `pathSecret` is generated when the app is created and can be regenerated by the app owner at any time through the dashboard.

## Modes of Operation

This API supports two modes:
- **Append Mode** (default): Adds new rows to the end of the sheet
- **Update Mode**: Updates existing rows based on an ID field

## Request Format

### Append Mode (Default)

```json
{
  "field1": "value1",
  "field2": "value2",
  "field3": "value3"
}
```

### Update Mode

```json
{
  "_updateId": "user123",
  "_idColumn": "A",
  "field1": "updated_value1",
  "field2": "updated_value2",
  "field3": "updated_value3"
}
```

**Special Parameters for Update Mode:**
- `_updateId`: The ID value to search for in the sheet (required for update mode)
- `_idColumn`: The column letter containing the ID field (optional, defaults to 'A')

Field names should match the column names in your Google Sheet. The special parameters `_updateId` and `_idColumn` are automatically removed before saving to the sheet.

## Response Format

### Success (200 OK)

#### Append Mode Response
```json
{
  "success": true,
  "message": "Form submitted successfully",
  "mode": "append",
  "updatedRange": "Sheet1!A5:C5"
}
```

#### Update Mode Response
```json
{
  "success": true,
  "message": "Form updated successfully",
  "mode": "update",
  "updatedRange": "Sheet1!A3:C3",
  "targetRow": 3
}
```

**Response Fields:**
- `success`: Boolean indicating operation success
- `message`: Human-readable success message
- `mode`: Operation mode ('append' or 'update')
- `updatedRange`: Google Sheets range that was modified
- `targetRow`: Row number that was updated (update mode only)

### Error (4xx/5xx)

```json
{
  "error": "Error message"
}
```

Common error codes:
- `400`: Invalid request body
- `403`: Invalid appId or pathSecret
- `404`: Row not found (update mode only)
- `429`: Rate limit exceeded
- `500`: Server error or Google Sheets API error

## Rate Limiting

Each app is limited to 100 submissions per hour. When a rate limit is exceeded, the API returns a 429 status code along with headers:

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1627384800
```

## Regenerating the Secret

App owners can regenerate the `pathSecret` at any time through the dashboard using the FormSubmissionUrl component. This is useful if you suspect the URL has been compromised or you need to revoke access.

## Example Usage

### JavaScript Append Example
```javascript
const submitForm = async (formData) => {
  const response = await fetch('/api/public/forms/app123/secret456/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: 'John Doe',
      email: 'john@example.com',
      status: 'active'
    })
  });
  
  const result = await response.json();
  console.log(result.message); // "Form submitted successfully"
};
```

### JavaScript Update Example
```javascript
const updateForm = async (userId, formData) => {
  const response = await fetch('/api/public/forms/app123/secret456/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      _updateId: userId,
      _idColumn: 'A',
      name: 'John Doe Updated',
      email: 'john.updated@example.com',
      status: 'active'
    })
  });
  
  const result = await response.json();
  console.log(result.message); // "Form updated successfully"
  console.log('Updated row:', result.targetRow);
};
```

## Implementation Details

1. The API uses the Supabase service role to access the app's data and the sheet owner's OAuth credentials
2. OAuth tokens are automatically refreshed if expired
3. **Update mode**: Searches the specified ID column to find matching rows before updating
4. **Append mode**: Adds new rows to the end of the sheet (default behavior)
5. Form data is cleaned by removing internal parameters before sending to Google Sheets
6. No API keys or OAuth credentials are exposed to client apps

## Security Considerations

- The `pathSecret` should be treated as a secret credential
- In production, consider implementing additional security measures like CORS restrictions
- Monitor form submissions for unusual patterns or abuse

## Usage in V0 Apps

When generating an app with V0, the prompt includes the form submission URL with the path secret. V0 will automatically use this URL to submit form data to the Google Sheet.
